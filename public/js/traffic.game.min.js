/*! Traffic 2014-10-10 */
!function(){"use strict";var a=null,b={id:"traffic-canvas",bitsize:48,gridsize:7,framerate:32,defaultSpeed:200},c=function(a){var a=a||{},c=this,d=!1,e=a.imageSrc||"",f=new Image,g=function(){},h=!1,i=!1,j=function(){var c=b.bitsize,d=b.bitsize,e=a.blocks;return e&&e.x&&(c=e.x*b.bitsize),e&&e.y&&(d=e.y*b.bitsize),{x:c,y:d}}();return this.name=a.name||"",this.x=a.x||0,this.y=a.y||0,this.scheduledX=!1,this.scheduledY=!1,this.turn=!1,this.allow=!1,this.speed=a.speed||b.defaultSpeed,this.movement=a.movement||"x",this.onRender=function(a){return g=a,this},this.render=function(){g()},this.checkCollision=function(){},this.move=function(a){var c=this.x,d=this.y,e=this.scheduledX,f=this.scheduledY;i&&h&&(e!==!1||f!==!1)&&("x"===this.movement?e>c+this.size("x")?this.x+=this.speed*a:e-b.bitsize<c?this.x-=this.speed*a:(console.log("here"),this.scheduledX=!1,h=!1,document.getElementById(b.id).dispatchEvent(new Event("traffic.change.turn"))):"y"===this.movement&&(f>d+this.size("y")?this.y+=this.speed*a:f-b.bitsize<d?this.y-=this.speed*a:(this.y=f,this.scheduledY=!1,h=!1)))},this.addEvent=function(a,d){var e=c.canvas||document.getElementById(b.id);return e.addEventListener(a,d,!1),this},this.isReady=function(){return d},this.getImage=function(){return f},this.size=function(a){return a?parseInt(j[a]):j},this.select=function(){return i=!0,h=!1,this},this.unselect=function(){return i=!1,this},this.isSelected=function(){return i},this.canSelect=function(a){return this.allow===a},this.scheduleMovement=function(a,c){return i&&(console.log("Clicked "+a),console.log("Current fartest edge "+Math.floor(this.size("x")+this.x)),console.log("Current nearest edge "+Math.floor(this.x)),"x"===this.movement.toLowerCase()?(this.scheduledX=Math.ceil(a/b.bitsize)*b.bitsize,console.log("Scheduled to move to "+this.scheduledX)):(this.scheduledY=Math.ceil(c/b.bitsize)*b.bitsize,console.log("Scheduled to move to "+this.scheduledY)),h=!0),this},this.start=function(){return e?(f.src=e,f.onload=function(){d=!0}):d=!0,this},this},d=function(){var a=this,d={},e=Date.now(),f=Date.now(),g=f-e,h={},i=0,j=0,k=null,l=null;this.canvas=null,this.ctx=null;var m=function(){a.canvas=document.createElement("canvas"),a.ctx=a.canvas.getContext("2d"),a.canvas.width=b.bitsize*b.gridsize,a.canvas.height=b.bitsize*b.gridsize,a.canvas.id=b.id,document.getElementById("traffic-canvas-container").appendChild(a.canvas)},n=function(){},o=function(a){var b,c,e,f;for(b in d)if(d.hasOwnProperty(b)&&"background"!==d[b].name){e=d[b];for(c in d)d.hasOwnProperty(b)&&(f=d[c],f.name!==e.name&&"background"!==f.name&&e.checkCollision(f));k.name===e.name&&e.move(a)}},p=function(a){var c=window.innerWidth,d=c/2,e=document.getElementById(b.id).width,f=d-e/2;return a-f},q=function(a){return a},r=function(){a.addEntity("background",{blocks:{x:b.gridsize,y:b.gridsize},speed:0}),a.addEntity("player-1",{imageSrc:"images/monster.png",blocks:{x:2,y:1}}),a.addEntity("player-2",{blocks:{x:2,y:1}}),a.addEntity("truck-1",{blocks:{x:1,y:3},x:2*b.bitsize,y:0,movement:"y"}),a.addEntity("car-1",{blocks:{x:1,y:2},x:3*b.bitsize,y:0,movement:"y"})},s=function(){var b=a.entity("background"),c=a.entity("player-1"),d=a.entity("player-2"),e=a.entity("truck-1"),f=a.entity("car-1");b.onRender(function(){b.isReady()&&(a.ctx.beginPath(),a.ctx.rect(b.x,b.y,b.size("x"),b.size("y")),a.ctx.fillStyle="grey",a.ctx.fill())}).addEvent("traffic.change.turn",function(){c.turn?a.setTurn(d):d.turn&&a.setTurn(c)}),c.onRender(function(){c.isReady()&&(a.ctx.beginPath(),a.ctx.rect(c.x,c.y,c.size("x"),c.size("y")),a.ctx.fillStyle=c.isSelected()?"yellow":"red",a.ctx.fill())}).addEvent("click",function(b){var d=c.x,e=c.y,f=c.size("x")+c.x,g=c.size("y")+c.y,h=p(b.x),i=q(b.y);c.canSelect(l.name)&&h>=d&&f>=h&&i>=e&&g>=i?a.selectEntity(c):c.scheduleMovement(h,i)}),d.onRender(function(){d.isReady()&&(a.ctx.beginPath(),a.ctx.rect(d.x,d.y,d.size("x"),d.size("y")),a.ctx.fillStyle=d.isSelected()?"yellow":"blue",a.ctx.fill())}).addEvent("click",function(b){var c=d.x,e=d.y,f=d.size("x")+d.x,g=d.size("y")+d.y,h=p(b.x),i=q(b.y);d.canSelect(l.name)&&h>=c&&f>=h&&i>=e&&g>=i?a.selectEntity(d):d.scheduleMovement(h,i)}),e.onRender(function(){e.isReady()&&(a.ctx.beginPath(),a.ctx.rect(e.x,e.y,e.size("x"),e.size("y")),a.ctx.fillStyle=e.isSelected()?"yellow":"white",a.ctx.fill())}).addEvent("click",function(b){var c=e.x,d=e.y,f=e.size("x")+e.x,g=e.size("y")+e.y,h=p(b.x),i=q(b.y);e.canSelect(l.name)&&h>=c&&f>=h&&i>=d&&g>=i?a.selectEntity(e):e.scheduleMovement(h,i)}),f.onRender(function(){f.isReady()&&(a.ctx.beginPath(),a.ctx.rect(f.x,f.y,f.size("x"),f.size("y")),a.ctx.fillStyle=f.isSelected()?"yellow":"purple",a.ctx.fill())}).addEvent("click",function(b){var c=f.x,d=f.y,e=f.size("x")+f.x,g=f.size("y")+f.y,h=p(b.x),i=q(b.y);f.canSelect(l.name)&&h>=c&&e>=h&&i>=d&&g>=i?a.selectEntity(f):f.scheduleMovement(h,i)})};return this.addEntity=function(a,b){return b=b||{},b.name=a,d[a]=new c(b),d[a].start(),d[a]},this.entity=function(a){if(d[a])return d[a];throw new Exception("Could not find Entity '"+a+"'")},this.selectEntity=function(a){var b;for(b in d)d.hasOwnProperty(b)&&d[b].unselect();return a.select(),k=a,this},this.setTurn=function(a){var b;this.selectEntity(a);for(b in d)d.hasOwnProperty(b)&&(d[b].allow=a.name,d[b].turn=!1);return console.log(d),"player-1"===a.name?d["player-2"].allow=!1:"player-2"===a.name&&(d["player-1"].allow=!1),a.turn=!0,l=a,this},this.start=function(){m(),r(),s(),addEventListener("keydown",function(a){h[a.keyCode]=!0},!1),addEventListener("keyup",function(a){delete h[a.keyCode]},!1),this.reset(),this.main()},this.reset=function(){var a=this.entity("player-1"),c=this.entity("player-2");this.setTurn(a),a.x=0,a.y=1*b.bitsize,c.x=b.bitsize*b.gridsize-c.size("x"),c.y=b.bitsize*b.gridsize-c.size("y")-b.bitsize},this.update=function(a){n(a),o(a)},this.render=function(){this.entity("background").render(),this.entity("player-1").render(),this.entity("player-2").render(),this.entity("truck-1").render(),this.entity("car-1").render(),this.ctx.fillStyle="rgb(0,0,0)",this.ctx.font="12px Helvetica",this.ctx.textAlign="left",this.ctx.textBaseline="top",this.ctx.fillText("Selected: "+k.name,b.bitsize/4,b.bitsize/4),this.ctx.fillText("Turn: "+l.name,b.bitsize/4,b.bitsize/2),this.ctx.fillText("FPS: "+this.getFPS(),b.bitsize/4,b.bitsize-b.bitsize/4)},this.getFPS=function(){i++;var a=f,b=(a-j)/1e3,c=Math.floor(i/b);return b>1&&(j=(new Date).getTime(),i=0),c},this.main=function(){f=Date.now(),g=f-e,a.update(g/1e3),a.render(),e=f,requestAnimationFrame(a.main)},this};a=new d,a.start()}();