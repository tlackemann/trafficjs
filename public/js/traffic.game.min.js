/*! Traffic 2014-10-09 */
!function(){"use strict";var a=null,b={bitsize:48,framerate:32},c=function(a){var a=a||{},c=!1,d=a.imageSrc||"",e=new Image,f=function(){},g=function(){var c=b.bitsize,d=b.bitsize,e=a.blocks;return e&&e.x&&(c=e.x*b.bitsize),e&&e.y&&(d=e.y*b.bitsize),{x:c,y:d}}();return this.x=0,this.y=0,this.selected=!1,this.speed=a.speed||0,this.onRender=function(a){return f=a,this},this.render=function(){f()},this.addEvent=function(a,b){addEventListener(a,b,!1)},this.isReady=function(){return c},this.getImage=function(){return e},this.size=function(a){return a?g[a]:g},this.start=function(){return d?(e.src=d,e.onload=function(){c=!0}):c=!0,this},this},d=function(){var a=this,b={},d=Date.now(),e=Date.now(),f=e-d,g={},h=0,i=0,j=!1;this.canvas=document.getElementById("traffic-canvas"),this.ctx=this.canvas.getContext("2d");var k=function(b){38 in g&&(a.entity("player").y-=a.entity("player").speed*b),40 in g&&(a.entity("player").y+=a.entity("player").speed*b),37 in g&&(a.entity("player").x-=a.entity("player").speed*b),39 in g&&(a.entity("player").x+=a.entity("player").speed*b)},l=function(){a.entity("player").x<=a.entity("opponent").x+32&&a.entity("opponent").x<=a.entity("player").x+32&&a.entity("player").y<=a.entity("opponent").y+32&&a.entity("opponent").y<=a.entity("player").y+32&&a.reset()},m=function(){a.addEntity("background",{blocks:{x:12,y:12}}),a.addEntity("player",{blocks:{x:2,y:1},speed:200}),a.addEntity("opponent",{blocks:{x:2,y:1},speed:200})},n=function(){var b=a.entity("background"),c=a.entity("player"),d=a.entity("opponent");b.onRender(function(){b.isReady()&&(a.ctx.beginPath(),a.ctx.rect(b.x,b.y,b.size("x"),b.size("y")),a.ctx.fillStyle="grey",a.ctx.fill())}),c.onRender(function(){c.isReady()&&(a.ctx.beginPath(),a.ctx.rect(c.x,c.y,c.size("x"),c.size("y")),a.ctx.fillStyle=c.selected?"yellow":"red",a.ctx.fill())}).addEvent("click",function(b){var d=c.x,e=c.y,f=c.size("x")+c.x,g=c.size("y")+c.y;b.x>=d&&b.x<=f&&b.y>=e&&b.y<=g&&a.selectEntity(c)}),d.onRender(function(){d.isReady()&&(a.ctx.beginPath(),a.ctx.rect(d.x,d.y,d.size("x"),d.size("y")),a.ctx.fillStyle=d.selected?"yellow":"blue",a.ctx.fill())}).addEvent("click",function(b){var c=d.x,e=d.y,f=d.size("x")+d.x,g=d.size("y")+d.y;b.x>=c&&b.x<=f&&b.y>=e&&b.y<=g&&a.selectEntity(d)})};return this.addEntity=function(a,d){return b[a]=new c(d),b[a].start(),b[a]},this.entity=function(a){if(b[a])return b[a];throw new Exception("Could not find Entity '"+a+"'")},this.selectEntity=function(a){var c;for(c in b)b.hasOwnProperty(c)&&(b[c].selected=!1);return a.selected=!0,j=a,this},this.start=function(){m(),n(),addEventListener("keydown",function(a){g[a.keyCode]=!0},!1),addEventListener("keyup",function(a){delete g[a.keyCode]},!1),this.main()},this.reset=function(){var a=this.entity("player"),b=this.entity("opponent");this.selectEntity(a),a.x=0,a.y=0,b.x=200,b.y=200},this.update=function(a){k(a),l(a)},this.render=function(){this.entity("background").render(),this.entity("player").render(),this.entity("opponent").render(),this.ctx.fillStyle="rgb(250, 250, 250)",this.ctx.font="24px Helvetica",this.ctx.textAlign="left",this.ctx.textBaseline="top",this.ctx.fillText("FPS: "+this.getFPS(),32,32)},this.getFPS=function(){h++;var a=e,b=(a-i)/1e3,c=Math.floor(h/b);return b>1&&(i=(new Date).getTime(),h=0),c},this.main=function(){e=Date.now(),f=e-d,a.update(f/1e3),a.render(),d=e,requestAnimationFrame(a.main)},this};a=new d,a.start()}();