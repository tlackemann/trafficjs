/*! Traffic 2014-10-13 */
var Config={container:"traffic-demo",id:"traffic-canvas",bitsize:50,gridsize:7,defaultSpeed:200,debug:!0,debugFps:!0,debugObjects:!0,levels:[]};Config.levels.push({name:"Testing Grounds",background:"lightgrey",exits:{"player-1":{x:6,y:2},"player-2":{x:0,y:5}},objects:{"player-1":{blocks:{x:2,y:1},x:2,y:2,movement:"x",color:"firebrick"},"player-2":{blocks:{x:2,y:1},x:4,y:5,movement:"x",color:"firebrick"},"truck-1":{blocks:{x:3,y:1},x:0,y:0,movement:"x",color:"#1485CC"},"truck-2":{blocks:{x:1,y:3},x:1,y:4,movement:"y",color:"dodgerblue"},"truck-3":{blocks:{x:3,y:1},x:4,y:6,movement:"x",color:"slategray"},"truck-4":{blocks:{x:1,y:3},x:4,y:0,movement:"y",color:"gold"},"truck-5":{blocks:{x:1,y:3},x:6,y:3,movement:"y",color:"plum"},"car-1":{blocks:{x:1,y:2},movement:"y",x:0,y:1,color:"purple"},"car-2":{blocks:{x:2,y:1},movement:"x",x:1,y:1,color:"pink"},"car-3":{blocks:{x:2,y:1},movement:"x",x:0,y:3,color:"green"},"car-4":{blocks:{x:2,y:1},movement:"x",x:2,y:6,color:"palegreen"},"car-5":{blocks:{x:1,y:2},movement:"y",x:3,y:0,color:"peru"},"car-6":{blocks:{x:1,y:2},movement:"y",x:6,y:0,color:"seagreen"}}});var Entity=function(a){var a=a||{},b=this,c=!1,d=a.imageSrc||"",e=new Image,f=function(){},g=!1,h=!1,i=!1,j=!1,k=!1,l=!1,m=function(){var b=Config.bitsize,c=Config.bitsize,d=a.blocks;return d&&d.x&&(b=d.x*Config.bitsize),d&&d.y&&(c=d.y*Config.bitsize),{x:b,y:c}}(),n=function(a){"x"===b.movement&&((!i||i&&i<a.x)&&a.x===b.x+b.size("x")&&(b.y===a.y||b.y<a.y+a.size("y"))&&(i=a.x),(!k||k&&k>a.x)&&a.x+a.size("x")===b.x&&(b.y===a.y||b.y<a.y+a.size("y")&&b.y+b.size("y")>a.y)&&(k=b.x)),"y"===b.movement&&((!j||j&&j<a.y)&&a.y===b.y+b.size("y")&&(b.x===a.x||b.x<a.x+a.size("x"))&&(j=a.y),(!l||l&&l>a.y)&&a.y+a.size("y")===b.y&&(b.x===a.x||b.x<a.x+a.size("x")&&b.x+b.size("x")>a.x)&&(l=b.y))};return this.name=a.name||"",this.color=a.color||"blue",this.x=a.x||0,this.y=a.y||0,this.scheduledX=!1,this.scheduledY=!1,this.turn=!1,this.allow=!1,this.speed=a.speed||Config.defaultSpeed,this.moveable=a.moveable||!0,this.movement=a.movement||"x",this.onRender=function(a){return f=a,this},this.checkCollision=function(a){return a.x>this.x+this.size("x")||a.x+a.size("x")<this.x||a.y>this.y+this.size("y")||a.y+a.size("y")<this.y?!1:(n(a),!0)},this.render=function(){f()},this.move=function(a){var b=this.x,c=this.y,d=this.scheduledX,e=this.scheduledY;this.moveable&&h&&g&&(d!==!1||e!==!1)&&("x"===this.movement?(d>b+this.size("x")&&(!i||b+this.size("x")<i)?this.x+=this.speed*a:d-Config.bitsize<b&&(!k||b>k)&&(this.x-=this.speed*a),(d-Config.bitsize==Math.ceil(b)||d-Config.bitsize==Math.floor(b))&&(this.x=d-Config.bitsize,this.scheduledX=!1),(d==Math.ceil(b)+this.size("x")||d==Math.floor(b)+this.size("x"))&&(this.x=d-this.size("x"),this.scheduledX=!1)):"y"===this.movement&&(e>c+this.size("y")&&(!j||c+this.size("y")<j)?this.y+=this.speed*a:e-Config.bitsize<c&&(!l||c>l)&&(this.y-=this.speed*a),(e-Config.bitsize==Math.ceil(c)||e-Config.bitsize==Math.floor(c))&&(this.y=e-Config.bitsize,this.scheduledY=!1),(e==Math.ceil(c)+this.size("y")||e==Math.floor(c)+this.size("y"))&&(this.y=e-this.size("y"),this.scheduledY=!1)))},this.addEvent=function(a,c){var d=b.canvas||document.getElementById(Config.id);return d.addEventListener(a,c,!1),this},this.isReady=function(){return c},this.getImage=function(){return d?e:!1},this.size=function(a){return a?parseInt(m[a]):m},this.select=function(){return h=!0,g=!1,this},this.unselect=function(){return h=!1,scheduledX=!1,scheduledY=!1,i=!1,j=!1,k=!1,l=!1,g=!1,this},this.isSelected=function(){return h},this.canSelect=function(a){return this.allow===a},this.scheduleMovement=function(a,b){var c=Math.ceil(a/Config.bitsize)*Config.bitsize,d=Math.ceil(b/Config.bitsize)*Config.bitsize;return h&&g?"x"===this.movement.toLowerCase()?this.scheduledX=c:"y"===this.movement.toLowerCase()&&(this.scheduledY=d):g||(g=!0),this},this.start=function(){return this.x=this.x*Config.bitsize,this.y=this.y*Config.bitsize,d?(e.src=d,e.onload=function(){c=!0}):c=!0,this},this},Traffic=function(){var a=this,b={},c=Date.now(),d=Date.now(),e=d-c,f=0,g=0,h=null,i=null,j=!1;this.canvas=null,this.ctx=null;var k=function(){a.canvas=document.createElement("canvas"),a.ctx=a.canvas.getContext("2d"),a.canvas.width=Config.bitsize*Config.gridsize,a.canvas.height=Config.bitsize*Config.gridsize,a.canvas.id=Config.id,document.getElementById(Config.container).appendChild(a.canvas)},l=function(a){var c;if(h){for(c in b)b.hasOwnProperty(c)&&"background"!==b.name&&h.checkCollision(b[c]);h.move(a)}},m=function(a){var b=document.getElementById(Config.id).offsetLeft;return a-b},n=function(a){var b=document.getElementById(Config.id).offsetTop;return console.log(a),a-b},o=function(){if(!j){if(!Config.levels.length)throw"No levels specified in the Configuration file";j=Config.levels[Math.floor(Math.random()*Config.levels.length)]}},p=function(){var b,c;a.addEntity("background",{blocks:{x:Config.gridsize,y:Config.gridsize},speed:0,color:j.background});for(c in j.exits)j.exits.hasOwnProperty(c)&&(b=j.exits[c],a.addEntity("exit-"+c,{imageSrc:b.imageSrc,blocks:{x:1,y:1},x:b.x,y:b.y,movement:b.movement,color:"black"}));for(c in j.objects)j.objects.hasOwnProperty(c)&&(b=j.objects[c],a.addEntity(c,{imageSrc:b.imageSrc,blocks:b.blocks,x:b.x,y:b.y,movement:b.movement,color:b.color}))},q=function(b){return function(){b.isReady()&&(a.ctx.beginPath(),a.ctx.rect(b.x,b.y,b.size("x"),b.size("y")),a.ctx.fillStyle=b.color,a.ctx.fill(),b.isSelected()&&(a.ctx.save(),a.ctx.beginPath(),a.ctx.rect(b.x,b.y,b.size("x"),b.size("y")),a.ctx.fillStyle="white",a.ctx.globalAlpha=.2,a.ctx.fill(),a.ctx.restore(),a.ctx.beginPath(),a.ctx.lineWidth=2,a.ctx.strokeStyle="black",a.ctx.rect(b.x+2,b.y+2,b.size("x")-4,b.size("y")-4),a.ctx.stroke()),Config.debugObjects&&(a.ctx.font="12px Helvetica",a.ctx.textAlign="center",a.ctx.textBaseline="top",a.ctx.fillStyle="black",b.allow?a.ctx.fillText(b.name,b.x+b.size("x")/2,b.y+b.size("y")/2):a.ctx.fillText("[x] "+b.name,b.x+b.size("x")/2,b.y+b.size("y")/2),a.ctx.fillText(b.x+", "+b.y,b.x+b.size("x")/2,b.y+b.size("y")/2+12)))}},r=function(){var c,d=a.entity("background"),e=a.entity("player-1"),f=a.entity("player-2");d.onRender(function(){d.isReady()&&(d.getImage()?a.ctx.drawImage(d.getImage(),0,0):(a.ctx.beginPath(),a.ctx.rect(d.x,d.y,d.size("x"),d.size("y")),a.ctx.fillStyle=d.color,a.ctx.fill()))}).addEvent("traffic.change.turn",function(){e.turn?a.setTurn(f):f.turn&&a.setTurn(e)}).addEvent("click",function(c){var d,e,f,g,j,k,l,o=m(c.pageX),p=n(c.pageY);console.log("Clicked "+o+","+p);for(l in b)b.hasOwnProperty(l)&&(k=b[l],"background"!==k.name&&0!==k.name.indexOf("exit")&&(e=k.x,f=k.y,g=k.size("x")+k.x,j=k.size("y")+k.y,d=k.canSelect(i.name)&&o>=e&&g>=o&&p>=f&&j>=p,d&&a.selectEntity(k)));e=h.x,f=h.y,g=h.size("x")+h.x,j=h.size("y")+h.y,d=!1,"x"===h.movement?d=p>=f&&j>=p:"y"===h.movement&&(d=o>=e&&g>=o),d&&h.scheduleMovement(o,p)});for(c in b)b.hasOwnProperty(c)&&"background"!==b[c].name&&b[c].onRender(q(b[c]))};return this.addEntity=function(a,c){return c=c||{},c.name=a,b[a]=new Entity(c),b[a].start(),b[a]},this.entity=function(a){if(b[a])return b[a];throw"Could not find Entity '"+a+"'"},this.selectEntity=function(a){var c;for(c in b)b.hasOwnProperty(c)&&b[c].unselect();return a.select(),h=a,this},this.setTurn=function(a){var c;this.selectEntity(a);for(c in b)b.hasOwnProperty(c)&&(b[c].allow=a.name,b[c].turn=!1);return"player-1"===a.name?b["player-2"].allow=!1:"player-2"===a.name&&(b["player-1"].allow=!1),a.turn=!0,i=a,this},this.start=function(){k(),o(),p(),r(),this.reset(),this.main()},this.reset=function(){var a=this.entity("player-1");this.setTurn(a)},this.update=function(a){l(a)},this.render=function(){var a;for(a in b)b.hasOwnProperty(a)&&h.name!==b[a].name&&b[a].render();h.render(),Config.debug&&(this.ctx.fillStyle="rgb(0,0,0)",this.ctx.font="12px Helvetica",this.ctx.textAlign="left",this.ctx.textBaseline="top",this.ctx.fillText("Level: "+j.name,Config.bitsize/4,Config.bitsize/4),this.ctx.fillText("Selected: "+h.name,Config.bitsize/4,Config.bitsize-Config.bitsize/4),this.ctx.fillText("Turn: "+i.name,Config.bitsize/4,Config.bitsize/2)),Config.debugFps&&(this.ctx.fillStyle="rgb(0,0,0)",this.ctx.font="12px Helvetica",this.ctx.textAlign="left",this.ctx.textBaseline="top",this.ctx.fillText("FPS: "+this.getFPS(),Config.bitsize*Config.gridsize-Config.bitsize,Config.bitsize/4))},this.getFPS=function(){f++;var a=d,b=(a-g)/1e3,c=Math.floor(f/b);return b>1&&(g=(new Date).getTime(),f=0),c},this.main=function(){d=Date.now(),e=d-c,a.update(e/1e3),a.render(),c=d,requestAnimationFrame(a.main)},this};