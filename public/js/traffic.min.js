/*! Traffic 2014-10-11 */
var Config={id:"traffic-canvas",bitsize:64,gridsize:7,defaultSpeed:200,debug:!0,debugFps:!0,debugObjects:!0,levels:[{name:"Testing Grounds",background:"lightgrey",objects:{"player-1":{blocks:{x:2,y:1},x:2,y:2,movement:"x",color:"firebrick"},"player-2":{blocks:{x:2,y:1},x:4,y:5,movement:"x",color:"firebrick"},"truck-1":{blocks:{x:3,y:1},x:0,y:0,movement:"x",color:"#1485CC"},"truck-2":{blocks:{x:1,y:3},x:1,y:4,movement:"y",color:"dodgerblue"},"truck-3":{blocks:{x:3,y:1},x:4,y:6,movement:"x",color:"slategray"},"truck-4":{blocks:{x:1,y:3},x:4,y:0,movement:"y",color:"gold"},"truck-5":{blocks:{x:1,y:3},x:6,y:3,movement:"y",color:"plum"},"car-1":{blocks:{x:1,y:2},movement:"y",x:0,y:1,color:"purple"},"car-2":{blocks:{x:2,y:1},movement:"x",x:1,y:1,color:"pink"},"car-3":{blocks:{x:2,y:1},movement:"x",x:0,y:3,color:"green"},"car-4":{blocks:{x:2,y:1},movement:"x",x:2,y:6,color:"palegreen"},"car-5":{blocks:{x:1,y:2},movement:"y",x:3,y:0,color:"peru"},"car-6":{blocks:{x:1,y:2},movement:"y",x:6,y:0,color:"seagreen"}}}]},Entity=function(a){var a=a||{},b=this,c=!1,d=a.imageSrc||"",e=new Image,f=function(){},g=!1,h=!1,i=function(){var b=Config.bitsize,c=Config.bitsize,d=a.blocks;return d&&d.x&&(b=d.x*Config.bitsize),d&&d.y&&(c=d.y*Config.bitsize),{x:b,y:c}}();return this.name=a.name||"",this.color=a.color||"blue",this.x=a.x||0,this.y=a.y||0,this.scheduledX=!1,this.scheduledY=!1,this.turn=!1,this.allow=!1,this.speed=a.speed||Config.defaultSpeed,this.movement=a.movement||"x",this.onRender=function(a){return f=a,this},this.render=function(){f()},this.checkCollision=function(){},this.move=function(a){var b=this.x,c=this.y,d=this.scheduledX,e=this.scheduledY;h&&g&&(d!==!1||e!==!1)&&("x"===this.movement?d>b+this.size("x")?this.x+=this.speed*a:d-Config.bitsize<b?this.x-=this.speed*a:(this.scheduledX=!1,g=!1):"y"===this.movement&&(e>c+this.size("y")?this.y+=this.speed*a:e-Config.bitsize<c?this.y-=this.speed*a:(this.scheduledY=!1,g=!1)))},this.addEvent=function(a,c){var d=b.canvas||document.getElementById(Config.id);return d.addEventListener(a,c,!1),this},this.isReady=function(){return c},this.getImage=function(){return d?e:!1},this.size=function(a){return a?parseInt(i[a]):i},this.select=function(){return h=!0,g=!1,this},this.unselect=function(){return h=!1,this},this.isSelected=function(){return h},this.canSelect=function(a){return this.allow===a},this.scheduleMovement=function(a,b){return h&&!g&&("x"===this.movement.toLowerCase()?this.scheduledX=Math.ceil(a/Config.bitsize)*Config.bitsize:"y"===this.movement.toLowerCase()&&(this.scheduledY=Math.ceil(b/Config.bitsize)*Config.bitsize),g=!0),this},this.start=function(){return this.x=this.x*Config.bitsize,this.y=this.y*Config.bitsize,d?(e.src=d,e.onload=function(){c=!0}):c=!0,this},this};!function(a,b){"use strict";var c=null,d=function(){var c=this,d={},e=Date.now(),f=Date.now(),g=f-e,h={},i=0,j=0,k=null,l=null,m=!1;this.canvas=null,this.ctx=null;var n=function(){c.canvas=document.createElement("canvas"),c.ctx=c.canvas.getContext("2d"),c.canvas.width=a.bitsize*a.gridsize,c.canvas.height=a.bitsize*a.gridsize,c.canvas.id=a.id,document.getElementById("traffic-canvas-container").appendChild(c.canvas)},o=function(a){k&&k.move(a)},p=function(b){var c=window.innerWidth,d=c/2,e=document.getElementById(a.id).width,f=d-e/2;return b-f},q=function(a){return a},r=function(){if(!m){if(!a.levels.length)throw"No levels specified in the Configuration file";m=a.levels[Math.floor(Math.random()*a.levels.length)]}},s=function(){var b,d;c.addEntity("background",{blocks:{x:a.gridsize,y:a.gridsize},speed:0,color:m.background});for(d in m.objects)m.objects.hasOwnProperty(d)&&(b=m.objects[d],c.addEntity(d,{imageSrc:b.imageSrc,blocks:b.blocks,x:b.x,y:b.y,movement:b.movement,color:b.color}))},t=function(b){return function(){b.isReady()&&(c.ctx.beginPath(),c.ctx.rect(b.x,b.y,b.size("x"),b.size("y")),c.ctx.fillStyle=b.color,c.ctx.fill(),b.isSelected()&&(c.ctx.save(),c.ctx.beginPath(),c.ctx.rect(b.x,b.y,b.size("x"),b.size("y")),c.ctx.fillStyle="white",c.ctx.globalAlpha=.2,c.ctx.fill(),c.ctx.restore(),c.ctx.beginPath(),c.ctx.lineWidth=2,c.ctx.strokeStyle="black",c.ctx.rect(b.x+2,b.y+2,b.size("x")-4,b.size("y")-4),c.ctx.stroke()),a.debugObjects&&(c.ctx.font="12px Helvetica",c.ctx.textAlign="center",c.ctx.textBaseline="top",c.ctx.fillStyle="black",c.ctx.fillText(b.name,b.x+b.size("x")/2,b.y+b.size("y")/2)))}},u=function(){var a,b=c.entity("background"),e=c.entity("player-1"),f=c.entity("player-2");b.onRender(function(){b.isReady()&&(b.getImage()?c.ctx.drawImage(b.getImage(),0,0):(c.ctx.beginPath(),c.ctx.rect(b.x,b.y,b.size("x"),b.size("y")),c.ctx.fillStyle=b.color,c.ctx.fill()))}).addEvent("traffic.change.turn",function(){e.turn?c.setTurn(f):f.turn&&c.setTurn(e)}).addEvent("click",function(a){var b,e,f,g,h,i,j,m,n,o,r=p(a.x),s=q(a.y);for(n in d)if(d.hasOwnProperty(n)&&(i=d[n],m=!1,"background"!==i.name)){e=i.x,f=i.y,g=i.size("x")+i.x,h=i.size("y")+i.y,b=i.canSelect(l.name)&&r>=e&&g>=r&&s>=f&&h>=s;for(o in d)d.hasOwnProperty(o)&&k.name!==d[o].name&&"background"!==d[o].name&&(j=d[o],m=m?!1:c.checkCollision(i,j));b?c.selectEntity(i):m||k.scheduleMovement(r,s)}});for(a in d)d.hasOwnProperty(a)&&"background"!==d[a].name&&d[a].onRender(t(d[a]))};return this.checkCollision=function(a,b){return b.x>a.x+a.size("x")||b.x+b.size("x")<a.x||b.y>a.y+a.size("y")||b.y+b.size("y")<a.y?!1:(console.log(a.name+" is colliding with "+b.name),!0)},this.addEntity=function(a,c){return c=c||{},c.name=a,d[a]=new b(c),d[a].start(),d[a]},this.entity=function(a){if(d[a])return d[a];throw"Could not find Entity '"+a+"'"},this.selectEntity=function(a){var b;for(b in d)d.hasOwnProperty(b)&&d[b].unselect();return a.select(),k=a,this},this.setTurn=function(a){var b;console.log("Changing turns "+a.name),this.selectEntity(a);for(b in d)d.hasOwnProperty(b)&&(d[b].allow=a.name,d[b].turn=!1);return"player-1"===a.name?d["player-2"].allow=!1:"player-2"===a.name&&(d["player-1"].allow=!1),a.turn=!0,l=a,this},this.start=function(){n(),r(),s(),u(),addEventListener("keydown",function(a){h[a.keyCode]=!0},!1),addEventListener("keyup",function(a){delete h[a.keyCode]},!1),this.reset(),this.main()},this.reset=function(){var a=this.entity("player-1");this.setTurn(a)},this.update=function(a){o(a)},this.render=function(){var b;for(b in d)d.hasOwnProperty(b)&&k.name!==d[b].name&&d[b].render();k.render(),a.debug&&(this.ctx.fillStyle="rgb(0,0,0)",this.ctx.font="12px Helvetica",this.ctx.textAlign="left",this.ctx.textBaseline="top",this.ctx.fillText("Level: "+m.name,a.bitsize/4,a.bitsize/4),this.ctx.fillText("Selected: "+k.name,a.bitsize/4,a.bitsize-a.bitsize/4),this.ctx.fillText("Turn: "+l.name,a.bitsize/4,a.bitsize/2)),a.debugFps&&(this.ctx.fillStyle="rgb(0,0,0)",this.ctx.font="12px Helvetica",this.ctx.textAlign="left",this.ctx.textBaseline="top",this.ctx.fillText("FPS: "+this.getFPS(),a.bitsize*a.gridsize-a.bitsize,a.bitsize/4))},this.getFPS=function(){i++;var a=f,b=(a-j)/1e3,c=Math.floor(i/b);return b>1&&(j=(new Date).getTime(),i=0),c},this.main=function(){f=Date.now(),g=f-e,c.update(g/1e3),c.render(),e=f,requestAnimationFrame(c.main)},this};c=new d,c.start()}(Config,Entity);