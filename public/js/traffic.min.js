/*! Traffic 2014-10-11 */
var Config={id:"traffic-canvas",bitsize:50,gridsize:7,defaultSpeed:200,debug:!0,debugFps:!0,debugObjects:!1,levels:[]};Config.levels.push({name:"Testing Grounds",background:"lightgrey",exits:{"player-1":{x:6,y:2},"player-2":{x:0,y:5}},objects:{"player-1":{blocks:{x:2,y:1},x:2,y:2,movement:"x",color:"firebrick"},"player-2":{blocks:{x:2,y:1},x:4,y:5,movement:"x",color:"firebrick"},"truck-1":{blocks:{x:3,y:1},x:0,y:0,movement:"x",color:"#1485CC"},"truck-2":{blocks:{x:1,y:3},x:1,y:4,movement:"y",color:"dodgerblue"},"truck-3":{blocks:{x:3,y:1},x:4,y:6,movement:"x",color:"slategray"},"truck-4":{blocks:{x:1,y:3},x:4,y:0,movement:"y",color:"gold"},"truck-5":{blocks:{x:1,y:3},x:6,y:3,movement:"y",color:"plum"},"car-1":{blocks:{x:1,y:2},movement:"y",x:0,y:1,color:"purple"},"car-2":{blocks:{x:2,y:1},movement:"x",x:1,y:1,color:"pink"},"car-3":{blocks:{x:2,y:1},movement:"x",x:0,y:3,color:"green"},"car-4":{blocks:{x:2,y:1},movement:"x",x:2,y:6,color:"palegreen"},"car-5":{blocks:{x:1,y:2},movement:"y",x:3,y:0,color:"peru"},"car-6":{blocks:{x:1,y:2},movement:"y",x:6,y:0,color:"seagreen"}}});var Entity=function(a){var a=a||{},b=this,c=!1,d=a.imageSrc||"",e=new Image,f=function(){},g=!1,h=!1,i=function(){var b=Config.bitsize,c=Config.bitsize,d=a.blocks;return d&&d.x&&(b=d.x*Config.bitsize),d&&d.y&&(c=d.y*Config.bitsize),{x:b,y:c}}();return this.name=a.name||"",this.color=a.color||"blue",this.x=a.x||0,this.y=a.y||0,this.scheduledX=!1,this.scheduledY=!1,this.turn=!1,this.allow=!1,this.speed=a.speed||Config.defaultSpeed,this.movement=a.movement||"x",this.onRender=function(a){return f=a,this},this.render=function(){f()},this.move=function(a,b){var c,d,e=this.x,f=this.y,i=this.scheduledX,j=this.scheduledY,k=!1,l=!1;for(d in b)c=b[d],c.x+this.size("x")==this.x&&(this.y==c.y||this.y<=c.y&&this.y>=c.y+c.size("y"))&&(console.log("Colliding with "+c.name),l=!0,console.log("Cannot move backward"));h&&g&&(i!==!1||j!==!1)&&("x"===this.movement?(i>e+this.size("x")&&!k?this.x+=this.speed*a:i-Config.bitsize<e&&!l&&(this.x-=this.speed*a),(i-Config.bitsize==Math.ceil(e)||i-Config.bitsize==Math.floor(e))&&(this.x=i-Config.bitsize,this.scheduledX=!1),(i==Math.ceil(e)+this.size("x")||i==Math.floor(e)+this.size("x"))&&(this.x=i-this.size("x"),this.scheduledX=!1)):"y"===this.movement&&(j>f+this.size("y")?this.y+=this.speed*a:j-Config.bitsize<f&&(this.y-=this.speed*a),(j-Config.bitsize==Math.ceil(f)||j-Config.bitsize==Math.floor(f))&&(this.y=j-Config.bitsize,this.scheduledY=!1),(j==Math.ceil(f)+this.size("y")||j==Math.floor(f)+this.size("y"))&&(this.y=j-this.size("y"),this.scheduledY=!1)))},this.addEvent=function(a,c){var d=b.canvas||document.getElementById(Config.id);return d.addEventListener(a,c,!1),this},this.isReady=function(){return c},this.getImage=function(){return d?e:!1},this.size=function(a){return a?parseInt(i[a]):i},this.select=function(){return h=!0,g=!1,this},this.unselect=function(){return h=!1,this},this.isSelected=function(){return h},this.canSelect=function(a){return this.allow===a},this.scheduleMovement=function(a,b){return h&&g?"x"===this.movement.toLowerCase()?this.scheduledX=Math.ceil(a/Config.bitsize)*Config.bitsize:"y"===this.movement.toLowerCase()&&(this.scheduledY=Math.ceil(b/Config.bitsize)*Config.bitsize):g||(g=!0),this},this.start=function(){return this.x=this.x*Config.bitsize,this.y=this.y*Config.bitsize,d?(e.src=d,e.onload=function(){c=!0}):c=!0,this},this},Traffic=function(){var a=this,b={},c=Date.now(),d=Date.now(),e=d-c,f={},g=0,h=0,i=null,j=null,k=!1;this.canvas=null,this.ctx=null;var l=function(){a.canvas=document.createElement("canvas"),a.ctx=a.canvas.getContext("2d"),a.canvas.width=Config.bitsize*Config.gridsize,a.canvas.height=Config.bitsize*Config.gridsize,a.canvas.id=Config.id,document.getElementById("traffic-canvas-container").appendChild(a.canvas)},m=function(a,b){return b.x>a.x+a.size("x")||b.x+b.size("x")<a.x||b.y>a.y+a.size("y")||b.y+b.size("y")<a.y?!1:!0},n=function(a){var c,d,e={};if(i){for(d in b)b.hasOwnProperty(d)&&b[d].name!==i.name&&"background"!==b[d].name&&(c=b[d],m(i,c)&&(e[c.name]=c));i.move(a,e)}},o=function(a){var b=window.innerWidth,c=b/2,d=document.getElementById(Config.id).width,e=c-d/2;return a-e},p=function(a){return a},q=function(){if(!k){if(!Config.levels.length)throw"No levels specified in the Configuration file";k=Config.levels[Math.floor(Math.random()*Config.levels.length)]}},r=function(){var b,c;a.addEntity("background",{blocks:{x:Config.gridsize,y:Config.gridsize},speed:0,color:k.background});for(c in k.objects)k.objects.hasOwnProperty(c)&&(b=k.objects[c],a.addEntity(c,{imageSrc:b.imageSrc,blocks:b.blocks,x:b.x,y:b.y,movement:b.movement,color:b.color}))},s=function(b){return function(){b.isReady()&&(a.ctx.beginPath(),a.ctx.rect(b.x,b.y,b.size("x"),b.size("y")),a.ctx.fillStyle=b.color,a.ctx.fill(),b.isSelected()&&(a.ctx.save(),a.ctx.beginPath(),a.ctx.rect(b.x,b.y,b.size("x"),b.size("y")),a.ctx.fillStyle="white",a.ctx.globalAlpha=.2,a.ctx.fill(),a.ctx.restore(),a.ctx.beginPath(),a.ctx.lineWidth=2,a.ctx.strokeStyle="black",a.ctx.rect(b.x+2,b.y+2,b.size("x")-4,b.size("y")-4),a.ctx.stroke()),Config.debugObjects&&(a.ctx.font="12px Helvetica",a.ctx.textAlign="center",a.ctx.textBaseline="top",a.ctx.fillStyle="black",a.ctx.fillText(b.name,b.x+b.size("x")/2,b.y+b.size("y")/2),a.ctx.fillText(b.x+", "+b.y,b.x+b.size("x")/2,b.y+b.size("y")/2+12)))}},t=function(){var c,d=a.entity("background"),e=a.entity("player-1"),f=a.entity("player-2");d.onRender(function(){d.isReady()&&(d.getImage()?a.ctx.drawImage(d.getImage(),0,0):(a.ctx.beginPath(),a.ctx.rect(d.x,d.y,d.size("x"),d.size("y")),a.ctx.fillStyle=d.color,a.ctx.fill()))}).addEvent("traffic.change.turn",function(){e.turn?a.setTurn(f):f.turn&&a.setTurn(e)}).addEvent("click",function(c){var d,e,f,g,h,k,l,m,n=o(c.x),q=p(c.y);for(m in b)b.hasOwnProperty(m)&&(k=b[m],l=!1,"background"!==k.name&&(e=k.x,f=k.y,g=k.size("x")+k.x,h=k.size("y")+k.y,d=k.canSelect(j.name)&&n>=e&&g>=n&&q>=f&&h>=q,d&&a.selectEntity(k)));e=i.x,f=i.y,g=i.size("x")+i.x,h=i.size("y")+i.y,d=!1,"x"===i.movement?d=q>=f&&h>=q:"y"===i.movement&&(d=n>=e&&g>=n),d&&i.scheduleMovement(n,q)});for(c in b)b.hasOwnProperty(c)&&"background"!==b[c].name&&b[c].onRender(s(b[c]))};return this.addEntity=function(a,c){return c=c||{},c.name=a,b[a]=new Entity(c),b[a].start(),b[a]},this.entity=function(a){if(b[a])return b[a];throw"Could not find Entity '"+a+"'"},this.selectEntity=function(a){var c;for(c in b)b.hasOwnProperty(c)&&b[c].unselect();return a.select(),i=a,this},this.setTurn=function(a){var c;this.selectEntity(a);for(c in b)b.hasOwnProperty(c)&&(b[c].allow=a.name,b[c].turn=!1);return"player-1"===a.name?b["player-2"].allow=!1:"player-2"===a.name&&(b["player-1"].allow=!1),a.turn=!0,j=a,this},this.start=function(){l(),q(),r(),t(),addEventListener("keydown",function(a){f[a.keyCode]=!0},!1),addEventListener("keyup",function(a){delete f[a.keyCode]},!1),this.reset(),this.main()},this.reset=function(){var a=this.entity("player-1");this.setTurn(a)},this.update=function(a){n(a)},this.render=function(){var a;for(a in b)b.hasOwnProperty(a)&&i.name!==b[a].name&&b[a].render();i.render(),Config.debug&&(this.ctx.fillStyle="rgb(0,0,0)",this.ctx.font="12px Helvetica",this.ctx.textAlign="left",this.ctx.textBaseline="top",this.ctx.fillText("Level: "+k.name,Config.bitsize/4,Config.bitsize/4),this.ctx.fillText("Selected: "+i.name,Config.bitsize/4,Config.bitsize-Config.bitsize/4),this.ctx.fillText("Turn: "+j.name,Config.bitsize/4,Config.bitsize/2)),Config.debugFps&&(this.ctx.fillStyle="rgb(0,0,0)",this.ctx.font="12px Helvetica",this.ctx.textAlign="left",this.ctx.textBaseline="top",this.ctx.fillText("FPS: "+this.getFPS(),Config.bitsize*Config.gridsize-Config.bitsize,Config.bitsize/4))},this.getFPS=function(){g++;var a=d,b=(a-h)/1e3,c=Math.floor(g/b);return b>1&&(h=(new Date).getTime(),g=0),c},this.main=function(){d=Date.now(),e=d-c,a.update(e/1e3),a.render(),c=d,requestAnimationFrame(a.main)},this};